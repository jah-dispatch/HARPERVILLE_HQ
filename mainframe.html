<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harperville | Mainframe</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="noise"></div>
    
    <main class="dashboard-container">
        
        <header class="dashboard-header">
            <h2 class="system-status">SYSTEM: <span class="highlight">EN FLIGHT</span></h2>
            <a href="index.html" class="exit-link" id="gravity-link"><i class="fa-solid fa-power-off"></i> DEFY GRAVITY!</a>
        </header>

        <div class="bento-grid">
            
            <div class="card profile-card">
    <div class="card-content profile-content-align">
        <h3>Jack Aspen Harper</h3>
        <p class="role">Chief Sovereign Officer & Ozian Ambassador for The Emerald City</p>
        <p class="bio">Designing couture at the intersection of myth and modernity. Pruning for depth. Building the kingdom. Tossing dead-weight overboard for shark food.</p>
    </div>
</div>

            <a href="#" class="card vault-card">
                <div class="card-bg"></div>
                <div class="card-content">
                    <i class="fa-solid fa-layer-group icon-large"></i>
                    <h3>The Vault</h3>
                    <p>Couture & Assets</p>
                </div>
            </a>

            <a href="ledger.html" class="card ledger-card">
                <div class="card-content">
                    <i class="fa-solid fa-feather-pointed icon-large"></i>
                    <h3>The Ledger</h3>
                    <p>Rationales & Archives</p>
                </div>
            </a>

            <div class="card ivy-card" onclick="openIvyModal()" style="cursor: pointer;">
    <div class="card-bg-ivy"></div>
    <div class="card-content">
        <i class="fa-solid fa-cat icon-large"></i>
        <h3>I v1.5</h3>
        <p class="role">System Oracle</p>
        <div class="status-container">
            <span class="ivy-eye-glow-dot"></span>
            <p class="status-blink">STATUS: ONLINE & JUDGING YA ALREADY!</p>
        </div>
    </div>
</div>

            <div class="card status-card" onclick="openMapModal()" style="cursor: pointer; position: relative; overflow: hidden;">
    
    <div class="map-hover-cue">
        <i class="fa-solid fa-map"></i> VIEW OZIAN MAP
    </div>

    <div class="card-content">
        <div class="status-row">
            <i class="fa-solid fa-location-dot"></i>
            <span>117 Poppy Field Way</span><br>
            <span>The Emerald City, OZ 71025</span>
        </div>
        <div class="status-row">
            <i class="fa-solid fa-temperature-half"></i>
            <span>Operating Temp: Treadmill in a Heatwave</span>
        </div>
    </div>
</div>

           <div class="card music-card" style="padding: 0; overflow: hidden;">
<iframe allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write" frameborder="0" height="450" style="width:100%;max-width:660px;overflow:hidden;border-radius:10px;" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" src="https://embed.music.apple.com/us/playlist/the-life-of-jack-aspen-harper/pl.u-JPAZbdZFLrLrJb2"></iframe>
    </div>

        </div>
    </main>
    
    <div id="oz-map-modal" class="modal-overlay">
    <div class="modal-content map-modal-size">
        <div class="modal-header">
            <h3>SOVEREIGN GEOGRAPHY</h3>
            <button onclick="closeMapModal()" class="close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="map-wrapper">
            <img src="assets/images/oz-map-base.png" alt="Map of Oz" class="oz-base-image">
            
            <div class="map-pin pin-emerald" style="top: 45%; left: 48%;">
                <div class="pin-dot"></div>
                <span class="pin-label">THE EMERALD CITY</span>
            </div>

            <div class="map-pin pin-harperville" style="top: 48%; left: 32%;">
                <i class="fa-solid fa-star star-icon"></i>
                <span class="pin-label label-highlight">HARPERVILLEâ„¢ HQ</span>
            </div>

            <div class="map-pin" style="top: 28%; left: 82%;">
                <div class="pin-dot dot-red"></div>
                <span class="pin-label">POPPY FIELDS</span>
            </div>

            <div class="map-pin" style="top: 75%; left: 70%;">
                <div class="pin-dot"></div>
                <span class="pin-label">FIGHTING TREES</span>
            </div>

            <div class="map-pin" style="top: 18%; left: 10%;">
                <i class="fa-solid fa-water" style="color: rgba(255,255,255,0.7);"></i>
                <span class="pin-label">WESTERN SEA</span>
            </div>
        </div>
    </div>
</div>

<script>
    function openMapModal() {
        document.getElementById('oz-map-modal').style.display = 'flex';
    }
    function closeMapModal() {
        document.getElementById('oz-map-modal').style.display = 'none';
    }
</script>

<img id="broomstick-ride" src="assets/images/broomstick.png" alt="Levitation">

    <script>
        document.getElementById('gravity-link').addEventListener('click', function(e) {
            e.preventDefault(); // Stop the exit for a moment
            
            // Trigger the animation
            document.getElementById('broomstick-ride').classList.add('launch-sequence');
            
            // Wait 1.5 seconds, then exit
            setTimeout(function() {
                window.location.href = 'index.html';
            }, 1500);
        });
    </script>

    <div id="ivy-modal" class="modal-overlay">
    <div class="modal-content ivy-modal-size">
        <div class="modal-header">
            <h3>I v1.5 SYSTEM INTERFACE</h3>
            <button onclick="closeIvyModal()" class="close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="ivy-chat-wrapper">
            <div id="ivy-chat-log">
                </div>

            <form id="ivy-chat-form" onsubmit="sendMessage(event)">
                <input type="text" id="ivy-input" placeholder="Consult the Oracle..." autocomplete="off">
                <button type="submit" id="ivy-send-btn"><i class="fa-solid fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
</div>

<script>
    /* 1. MODAL CONTROLS */
    let hasGreeted = false;

    function openIvyModal() {
        document.getElementById('ivy-modal').style.display = 'flex';
        // Auto-greet only once per session
        if (!hasGreeted) {
            setTimeout(() => {
                appendMessage('ivy', "Status: Judging you. How can the Oracle assist?");
                hasGreeted = true;
            }, 500);
        }
    }

    function closeIvyModal() {
        document.getElementById('ivy-modal').style.display = 'none';
    }

    /* 2. CHAT LOGIC */
    let chatHistory = []; 

    async function sendMessage(e) {
        e.preventDefault(); 
        
        const inputField = document.getElementById('ivy-input');
        const userText = inputField.value.trim();

        if (!userText) return;

        // Show User Message
        appendMessage('user', userText);
        inputField.value = ''; 
        
        chatHistory.push({ role: "user", content: userText });

        // Show Loading State
        const loadingId = appendMessage('ivy', '...', true);

        try {
            // Call Netlify Function
            const response = await fetch('/.netlify/functions/ivy-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userText, history: chatHistory })
            });

            const data = await response.json();
            
            removeMessage(loadingId);
            
            if (data.reply) {
                appendMessage('ivy', data.reply);
                chatHistory.push({ role: "assistant", content: data.reply });
            } else {
                appendMessage('ivy', "Connection fuzzy. Try again.");
            }

        } catch (error) {
            removeMessage(loadingId);
            // This will print the ACTUAL error to the chat bubble
            appendMessage('ivy', "CRASH REPORT: " + error.message);
            console.error("Full Error:", error);
        }
    }

    // Helper: Create Bubbles
    function appendMessage(sender, text, isLoading = false) {
        const chatLog = document.getElementById('ivy-chat-log');
        const bubble = document.createElement('div');
        const msgId = 'msg-' + Date.now();
        
        bubble.id = msgId;
        bubble.className = `chat-bubble bubble-${sender} ${isLoading ? 'pulse-text' : ''}`;
        
        if (sender === 'ivy') {
            bubble.innerHTML = `<i class="fa-solid fa-cat" style="margin-right:8px;"></i> ${text}`;
        } else {
            bubble.innerText = text;
        }

        chatLog.appendChild(bubble);
        chatLog.scrollTop = chatLog.scrollHeight; 
        return msgId;
    }

    function removeMessage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }
</script>

</body>
</html>